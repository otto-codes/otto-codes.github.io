<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="UTF-8">
        <title>Powerant</title>
        <link rel="stylesheet" href="testi2_tiedostot/styles.css">
       <script src="testi2_tiedostot/script.js"></script>
       <style>
       .gg-log-out {
        box-sizing: border-box;
        position: relative;
        display: block;
        width: 6px;
        height: 16px;
        border: 2px solid;
        transform: scale(var(--ggs,1));
        border-right: 0;
        border-top-left-radius: 2px;
        border-bottom-left-radius: 2px;
        margin-left: -10px
       }
       
       .gg-log-out::after,
       .gg-log-out::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute
       }
       
       .gg-log-out::after {
        border-top: 2px solid;
        border-left: 2px solid;
        transform: rotate(-45deg);
        width: 8px;
        height: 8px;
        left: 4px;
        bottom: 2px
       }
       
       .gg-log-out::before {
        border-radius: 3px;
        width: 10px;
        height: 2px;
        background: currentColor;
        left: 5px;
        bottom: 5px
       } 
    </style>
      </head>
      <body>
        <div id="gg-log-out"></div>          
          <form class="form" action="/submit" method="POST">
          <div style="text-align: right">
          <div class="wifistatus"></div>
          <span onclick="confirmAndDisconnect()" style="display: inline-block; vertical-align: top; color:white" ;"="">Tylypahka</span>
          </div>
          <div class="title"><span style="font-weight: bolder;">POWER</span><span style="font-weight: lighter;">ANT</span></div>
          <div id="pricetable">
              <!-- Dropdown menu for date selection -->
                  <select id="date-select">
                      <option id="yesterday-menu" value="yesterday">Eilen</option>
                      <option id="today-menu" value="today" selected="selected">Tänään</option>
                      <option id="tomorrow-menu" value="tomorrow">Huomenna</option>
                  </select>
              <!-- tables -->
              <div id="price tables">
                  <div>
                      <div class="prices-container">
                          <div id="yesterday-data"></div>
                      </div>
                  </div>
                  <div class="current">
                      <div class="prices-container">
                          <div id="today-data">
                      <table>
                          <thead>
                              <tr>
                                  <th data-translate="Hour">Tunti</th>
                                  <th data-translate="Price">Hinta</th>
                                  <th data-translate="Electricity">Sähkö</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr><td>0-1</td><td>0.55</td><td><span class="power-on">Päällä</span></td></tr><tr><td>1-2</td><td>0.67</td><td><span class="power-on">Päällä</span></td></tr><tr><td>2-3</td><td>0.23</td><td><span class="power-on">Päällä</span></td></tr><tr><td>3-4</td><td>0.17</td><td><span class="power-on">Päällä</span></td></tr><tr><td>4-5</td><td>0.24</td><td><span class="power-on">Päällä</span></td></tr><tr><td>5-6</td><td>0.38</td><td><span class="power-on">Päällä</span></td></tr><tr><td>6-7</td><td>1.80</td><td><span class="power-on">Päällä</span></td></tr><tr><td>7-8</td><td>17.59</td><td><span class="power-off">Pois</span></td></tr><tr><td>8-9</td><td>21.49</td><td><span class="power-off">Pois</span></td></tr><tr><td>9-10</td><td>17.43</td><td><span class="power-off">Pois</span></td></tr><tr><td>10-11</td><td>13.75</td><td><span class="power-off">Pois</span></td></tr><tr><td>11-12</td><td>11.21</td><td><span class="power-off">Pois</span></td></tr><tr><td>12-13</td><td>9.84</td><td><span class="power-on">Päällä</span></td></tr><tr><td>13-14</td><td>8.36</td><td><span class="power-on">Päällä</span></td></tr><tr><td>14-15</td><td>6.87</td><td><span class="power-on">Päällä</span></td></tr><tr><td>15-16</td><td>6.20</td><td><span class="power-on">Päällä</span></td></tr><tr><td>16-17</td><td>10.67</td><td><span class="power-on">Päällä</span></td></tr><tr><td>17-18</td><td>13.77</td><td><span class="power-off">Pois</span></td></tr><tr><td>18-19</td><td>15.93</td><td><span class="power-off">Pois</span></td></tr><tr><td>19-20</td><td>24.80</td><td><span class="power-off">Pois</span></td></tr><tr><td>20-21</td><td>31.00</td><td><span class="power-off">Pois</span></td></tr><tr><td>21-22</td><td>28.00</td><td><span class="power-off">Pois</span></td></tr><tr><td>22-23</td><td>24.80</td><td><span class="power-off">Pois</span></td></tr><tr><td>23-24</td><td>13.77</td><td><span class="power-off">Pois</span></td></tr>
                          </tbody>
                      </table>
                  </div>
                      </div>
                  </div>
                  <div>
                      <div class="prices-container">
                          <div id="tomorrow-data"></div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="subtitle" id="subtitle">Määritä laitteesi:</div>
          <div class="button-container">
            <!-- Change type to 'button' to prevent form submission -->
            <button type="button" id="offButton" data-action="Off" class="off" onclick="updateStatus(event, 'Off')">Pois</button>
            <button type="button" id="autoButton" data-action="Automatic" class="auto" onclick="updateStatus(event, 'Automatic')">Automaattinen</button>
            <button type="button" id="onButton" data-action="On" class="on active" onclick="updateStatus(event, 'On')">Päällä</button>
          </div>
          <div class="input-container ic4">
          <select class="input" id="country" name="country"><option value="austria-at1">Austria</option><option value="belgium-be1">Belgium</option><option value="bulgaria-bg1">Bulgaria</option><option value="croatia-hr1">Croatia</option><option value="czech-republic-cz1">Czech Republic</option><option value="denmark-dk1">Denmark DK1</option><option value="denmark-dk2">Denmark DK2</option><option value="estonia-ee1">Estonia</option><option value="finland-fi1" selected="selected">Finland</option><option value="france-fr1">France</option><option value="germany-de1">Germany</option><option value="greece-gr1">Greece</option><option value="hungary-hu1">Hungary</option><option value="ireland-ie1">Ireland</option><option value="italy-calabria">Italy Calabria</option><option value="italy-centre-north">Italy Centre-North</option><option value="italy-centre-south">Italy Centre-South</option><option value="italy-north">Italy North</option><option value="italy-sacoac">Italy SACOAC</option><option value="italy-sacodc">Italy SACODC</option><option value="italy-sardinia">Italy Sardinia</option><option value="italy-sicily">Italy Sicily</option><option value="italy-south">Italy South</option><option value="latvia-lv1">Latvia</option><option value="lithuania-lt1">Lithuania</option><option value="netherlands-nl1">Netherlands</option><option value="norway-no1">Norway NO1</option><option value="norway-no2">Norway NO2</option><option value="norway-no3">Norway NO3</option><option value="norway-no4">Norway NO4</option><option value="norway-no5">Norway NO5</option><option value="poland-pl1">Poland</option><option value="portugal-pt1">Portugal</option><option value="romania-ro1">Romania</option><option value="serbia-rs1">Serbia</option><option value="spain-es1">Spain</option><option value="sweden-se1">Sweden SE1</option><option value="sweden-se2">Sweden SE2</option><option value="sweden-se3">Sweden SE3</option><option value="sweden-se4">Sweden SE4</option></select>
            <div class="cut cut-short"></div>
            
            <label for="country" class="placeholder country" id="countryLabel">Maa/Alue:</label>
            </div>
              <div class="input-container ic5">
                <select id="hours" name="hours" class="input"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12" selected="selected">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option></select>
                <div class="cut cut-short"></div>
                <label for="hours" class="placeholder hours" id="hoursLabel">Halvimmat tunnit</label>
              </div>
              <div class="input-container ic6">
                <input type="number" id="maxprice" name="maxprice" class="input" value="10" step="0.01">
                <div class="cut cut-short"></div>
                <label for="maxprice" class="placeholder maxprice" id="maxpriceLabel">Hintakatto</label>
              </div>
              <div class="checkbox-container">
                <input type="checkbox" id="show-settings" name="show-settings" onchange="toggleSettings()">
                <label for="show-settings" class="checkbox-label" id="settingsLabel">Näytä lisäasetukset:</label>
              </div>
              <div id="additional-settings" style="display:none;">
                <div class="input-container ic3">
                  <label class="checkbox-label" id="keyStatus">Tuoteavain: </label><span class="checkbox-label">ddd-ddd-ddd-ddd</span> <br>
                  <label class="checkbox-label" id="ip-label">IP Address: </label><span class="checkbox-label">192.168.68.106</span>
                </div>
                <div class="input-container ic7">
                  <input type="text" id="static-ip" name="static-ip" class="input">
                  <div class="cut"></div>
                  <label for="static-ip" class="placeholder staticip" id="ipLabel">Staattinen IP-osoite</label>
                </div>
                <div class="input-container ic8">
                  <input type="text" id="server-address" name="server-address" class="input">
                  <div class="cut"></div>
                  <label for="server-address" class="placeholder server" id="serverLabel">Palvelimen osoite</label>
                </div>
                <div class="checkbox-container">
                <input type="checkbox" id="configure-lan" name="configure-lan" value="on" onchange="toggleLANFields()">
                <label for="configure-lan" class="checkbox-label" id="lanConfigLabel">Määritä LAN:n kautta:</label>
                </div>
                <div id="lan-fields" style="display:none;">
                  <div class="input-container ic8">
                    <input type="text" id="lan-username" name="lan-username" class="input">
                    <div class="cut"></div>
                    <label for="lan-username" class="placeholder lanuser" id="lanUserLabel">LAN-käyttäjätunnus</label>
                  </div>
                  <div class="input-container ic10">
                    <input type="password" id="lan-password" name="lan-password" class="input" value="">
                    <div class="cut"></div>
                    <label for="lan-password" class="placeholder lanpassword" id="lanPasswordLabel">LAN-salasana</label>
                  </div>
                </div>
                <div class="checkbox-container">
                <input type="checkbox" id="remote-control" name="remote-control" value="on" onchange="toggleAppFields()">
                <label for="remote-control" class="checkbox-label" id="remoteControlLabel">Etäohjaus Powerant-sovelluksella:</label>
                </div>
              </div>
              <input type="submit" class="submit" value="Tallenna" id="saveButton">
            </form>
            <footer>
            <script>
              let currentStatus = 'On'; 
              function setActiveButton(action) {
                  const buttons = document.querySelectorAll('button');
                  buttons.forEach(btn => {
                      if (btn.dataset.action === action) { // Use the passed action for comparison
                          btn.classList.add('active');
                      } else {
                          btn.classList.remove('active');
                      }
                  });
              }

              function updateStatus(event, action) {
                  event.preventDefault();  // Prevent form submission
                  if (action == 'On'){

                  }

                  // Update global currentStatus with the new action
                  currentStatus = action;
                  
                  // Call setActiveButton with the updated status
                  setActiveButton(currentStatus);

                  // Encode the currentStatus to ensure it's correctly formatted for a URL
                  const data = "deviceAction=" + encodeURIComponent(currentStatus);

                  const xhr = new XMLHttpRequest();
                  xhr.open("POST", "/submit", true);
                  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                  xhr.send(data); // Send the data including the currentStatus
              }

              window.onload = function() {
                  setActiveButton(currentStatus); // Set the correct active button when the page loads
              };
              const priceData = {"2024060201": 0.51, "2024060202": 0.32, "2024060203": 0.2, "2024060204": 0.12, "2024060205": 0.14, "2024060206": 0.26, "2024060207": 0.61, "2024060208": 0.51, "2024060209": 0.37, "2024060210": 0.98, "2024060211": 0.9, "2024060212": 1.48, "2024060213": 1.8, "2024060214": 2.37, "2024060215": 2.65, "2024060216": 2.05, "2024060217": 4.96, "2024060218": 4.96, "2024060219": 12.62, "2024060220": 13.67, "2024060221": 5.3, "2024060222": 10.23, "2024060223": 8.44, "2024060300": 1.73, "2024060301": 1.32, "2024060302": 1.17, "2024060303": 1.05, "2024060304": 0.97, "2024060305": 1.09, "2024060306": 1.2, "2024060307": 16.13, "2024060308": 31.0, "2024060309": 24.8, "2024060310": 23.56, "2024060311": 16.87, "2024060312": 15.25, "2024060313": 12.42, "2024060314": 9.92, "2024060315": 8.93, "2024060316": 8.94, "2024060317": 9.5, "2024060318": 13.59, "2024060319": 16.5, "2024060320": 22.61, "2024060321": 4.96, "2024060322": 1.88, "2024060323": 1.21, "2024060400": 0.55, "2024060401": 0.67, "2024060402": 0.23, "2024060403": 0.17, "2024060404": 0.24, "2024060405": 0.38, "2024060406": 1.8, "2024060407": 17.59, "2024060408": 21.49, "2024060409": 17.43, "2024060410": 13.75, "2024060411": 11.21, "2024060412": 9.84, "2024060413": 8.36, "2024060414": 6.87, "2024060415": 6.2, "2024060416": 10.67, "2024060417": 13.77, "2024060418": 15.93, "2024060419": 24.8, "2024060420": 31.0, "2024060421": 28.0, "2024060422": 24.8, "2024060423": 13.77, "2024060500": 3.44, "2024060501": 0.58, "2024060502": 0.35, "2024060503": 0.28, "2024060504": 0.2, "2024060505": 0.24, "2024060506": 0.57, "2024060507": 2.31, "2024060508": 18.21, "2024060509": 14.15, "2024060510": 6.82, "2024060511": 4.96, "2024060512": 2.93, "2024060513": 2.91, "2024060514": 1.58, "2024060515": 0.97, "2024060516": 0.65, "2024060517": 0.62, "2024060518": 0.66, "2024060519": 1.08, "2024060520": 1.4, "2024060521": 1.5, "2024060522": 1.54, "2024060523": 1.4, "2024060600": 0.91, "offset_hour": 3.0};
              const priceTrigger = 10; // Price below which the device is considered ON
              const cheapestHours = 12; // Number of hours when the device should be ON at the cheapest rates

              function calculateCheapestHours(data, count) {
                  return Object.entries(data)
                      .sort((a, b) => a[1] - b[1])
                      .slice(0, count)
                      .reduce((acc, [key,]) => ({ ...acc, [key]: true }), {});
              }

                // Default user language detection
                const userLang = (navigator.language || navigator.userLanguage).substring(0, 2); // Detect browser language once
              let currentTranslations = {}; // Cache for storing current translations

              // Translation dictionary
              const translations = {
                  'Yesterday': {
                      'fi': 'Eilen',
                      'sv': 'Igår',
                      'no': 'I går'
                  },
                  'Today': {
                      'fi': 'Tänään',
                      'sv': 'Idag',
                      'no': 'I dag'
                  },
                  'Tomorrow': {
                      'fi': 'Huomenna',
                      'sv': 'Imorgon',
                      'no': 'I morgen'
                  },
                  'Hour': {
                      'fi': 'Tunti',
                      'sv': 'Timme',
                      'no': 'Time'
                  },
                  'Price': {
                      'fi': 'Hinta',
                      'sv': 'Pris',
                      'no': 'Pris'
                  },
                  'Electricity': {
                      'fi': 'Sähkö',
                      'sv': 'Elektricitet',
                      'no': 'Elektrisitet'
                  },
                  'ON': {
                      'fi': 'Päällä',
                      'sv': 'På',
                      'no': 'På'
                  },
                  'OFF': {
                      'fi': 'Pois',
                      'sv': 'Av',
                      'no': 'Av'
                  },
                  'offButton': {
                      'fi': 'Pois',
                      'sv': 'Av',
                      'no': 'Av'
                  },
                  'autoButton': {
                      'fi': 'Automaattinen',
                      'sv': '-',
                      'no': '-'
                  },
                  'onButton': {
                      'fi': 'Päällä',
                      'sv': 'På',
                      'no': 'På'
                  },
              };

              // Function to preload translations and cache them
              function preloadTranslations() {
                  Object.keys(translations).forEach(key => {
                      currentTranslations[key] = translations[key][userLang] || key;
                  });
              }

              // Translate static text elements
              function translateStaticText() {
                  document.getElementById('yesterday-menu').textContent = getTranslation('Yesterday');
                  document.getElementById('today-menu').textContent = getTranslation('Today');
                  document.getElementById('tomorrow-menu').textContent = getTranslation('Tomorrow');
                  document.getElementById('offButton').textContent = getTranslation('offButton');
                  document.getElementById('autoButton').textContent = getTranslation('autoButton');
                  document.getElementById('onButton').textContent = getTranslation('onButton');
              }

              // Function to get translation from cached data
              function getTranslation(key) {
                  return currentTranslations[key];
              }

            /// Generate HTML for table with dynamic data
              function generateTableHTML(dateKeyPrefix) {

                  const filteredData = Object.entries(priceData)
                      .filter(([key,]) => key.startsWith(dateKeyPrefix));

                  const cheapestHoursKeys = calculateCheapestHours(Object.fromEntries(filteredData), cheapestHours);

                  const tableRows = filteredData.map(([key, value]) => {
                      const hour = parseInt(key.slice(8, 10), 10);
                      const isCheapest = cheapestHoursKeys[key];
                      
                      const isOn = currentStatus == 'On' || value <= priceTrigger || isCheapest;
                      if (currentstatus == 'Off'){
                        isOn = false;
                      }
                      const electricityStatus = isOn ? `<span class='power-on'>${getTranslation('ON')}</span>` : `<span class='power-off'>${getTranslation('OFF')}</span>`;
                      return `<tr><td>${hour}-${hour + 1}</td><td>${value.toFixed(2)}</td><td>${electricityStatus}</td></tr>`;
                  });

                  return `
                      <table>
                          <thead>
                              <tr>
                                  <th data-translate="Hour">${getTranslation('Hour')}</th>
                                  <th data-translate="Price">${getTranslation('Price')}</th>
                                  <th data-translate="Electricity">${getTranslation('Electricity')}</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${tableRows.join('')}
                          </tbody>
                      </table>
                  `;
              }


              // Update the active progress indicator
              function updateActiveProgress(activeMenuId) {
                  document.querySelectorAll("#date li").forEach(menuItem => {
                      menuItem.classList.remove("active");
                  });
                  document.getElementById(activeMenuId).classList.add("active");
              }

            document.addEventListener("DOMContentLoaded", function () {
                  preloadTranslations(); // Preload and cache translations
                  translateStaticText();

                  const selectMenu = document.getElementById('date-select');
                  
                  selectMenu.addEventListener("change", function () {
                      const selectedDate = selectMenu.value;
                      const dateOffset = {
                          'yesterday': -86400000,
                          'today': 0,
                          'tomorrow': 86400000
                      };
                      
                      const targetDate = new Date(Date.now() + dateOffset[selectedDate]).toISOString().slice(0, 10).replace(/-/g, '');
                      
                      document.getElementById('yesterday-data').innerHTML = '';
                      document.getElementById('today-data').innerHTML = '';
                      document.getElementById('tomorrow-data').innerHTML = '';
                      document.getElementById(`${selectedDate}-data`).innerHTML = generateTableHTML(targetDate);
                  });

                  // Initially load today's data
                  document.getElementById('today-data').innerHTML = generateTableHTML(new Date().toISOString().slice(0, 10).replace(/-/g, ''));
              });
          </script>

            </footer>

            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #f0f0f0; font-family: 'Arial', sans-serif;">
                <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;"> <!-- Container for "Logged in as" and username -->
                        <span id="logged-in-as" style="font-size: 24px; color: #333;">Logged in as</span>
                        <span id="username" style="font-size: 24px; color: #333;">Username</span> <!-- Username displayed here -->
                    </div>
                    <button id="logout-button" style="background-color: #5db268; width: 100%; font-size: 24px; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, box-shadow 0.3s;">Log Out</button>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="padding: 4px; position: relative; top: 12px; display: inline-block; border: 10px double transparent; border-top-color: #5db268; border-radius: 50%;">
                            <div style="height: 0; width: 0; border: 10px double transparent; border-top-color: #5db268; border-radius: 50%;"> </div>
                        </div>
                        <span style="font-size: 24px; color: #333;">Tylypahka</span>
                    </div>
                    <button id="disconnect-button" onclick="confirmAndDisconnect()" style="background-color: #5db268; width: 100%; font-size: 24px; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, box-shadow 0.3s; position: relative; bottom: 10px;">Disconnect</button>