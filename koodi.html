<style>
    /* basic reset */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Montserrat', Arial, Verdana;
        color: #333;
    }

    ul {
        margin: 0;
    }

    #msform {
        max-width: 80vw;
        margin: 0vw auto;
        text-align: center;
        box-shadow: 0 0 0.5vw 0.5vw rgba(0, 0, 0, 0.1);
        border-radius: 1vw;
    }

    #device-selector-container {
        width: 100%;
        text-align: center;
        /* box-shadow: 0 0 1vw 0.5vw rgba(0, 0, 0, 0.1); */
        margin-top: 3vw;
    }

    #msform fieldset {
        background: #f5f5f5;
        border: none;
        padding: 0vw;
        margin: 0px;
        /* box-shadow: 0 0 1vw 0.5vw rgba(0, 0, 0, 0.1); */
    }

    #msform input,
    #msform textarea {
        padding: 1.5vw;
        border-radius: 2px;
        margin-bottom: 0vw;
        width: 80%;
        background: #eaeaea;
        color: #333;
        font-size: 4vw;
        border: 0.5vw solid #bbb;
        text-align: center;
    }

    #device-form-container {
        background: #f5f5f5;
        border: none;
        padding: none;
    }

    #msform label {
        font-size: 4vw;
        padding-top: 4vw;
        text-transform: uppercase;
        color: #333;
    }

    select#device-selector {
        font-size: 5vw;
        text-align: center;
        text-transform: uppercase;
        border-top-left-radius: 1vw;
        border-top-right-radius: 1vw;
        background: #27AE60;
        border: 0vw solid #333;
        color: #ffffff;
        margin-bottom: 0vw;
        width: 100%;
        padding: 3vw;
    }

    #msform button {
        background: #27AE60;
        color: white;
        border: none;
        border-radius: 2vw;
        cursor: pointer;
        padding: 5vw;
        margin-bottom: 15vw;
        margin-top: 6vw;
        font-size: 4vw;
    }

    .fs-title {
        font-size: 6vw;
        text-transform: uppercase;
        color: #27AE60;
        padding: 2vw;
    }

    .fs-subtitle {
        font-weight: normal;
        font-size: 3.5vw;
        color: #666;
        text-align: center;
        padding: 4vw;
    }

    #progressbar {
        /* box-shadow: 0 0 2vw 1vw rgba(0, 0, 0, 0.1); */
        margin-top: 0vw;
        overflow: hidden;
        counter-reset: step;
        list-style-type: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
    }

    #progressbar li {
        color: #333;
        text-transform: uppercase;
        font-size: 2.5vw;
        width: 100%;
        position: relative;
        background: #eaeaea;
        padding: 2px;
    }

    #progressbar li:before {
        content: var(--date);
        height: 6vw;
        line-height: 6vw;
        display: block;
        font-size: 5vw;
        color: #333;
        background: #eaeaea;
        border-radius: 5px;
        margin: 0 auto 0vw auto;
    }

    #progressbar li.active:before,
    #progressbar li.active {
        background: #27AE60;
        color: white;
    }

    /* Animations, slides and transitions remain the same as they do not need a color change */

    .data-container table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0vw;
        text-align: center;
        table-layout: fixed;
    }

    .data-container th,
    .data-container td {
        padding: 0.7vw;
        border-bottom: 0.2vw solid #bbb;
        text-align: center;
    }

    .data-container th {
        background-color: #d4d4d4;
        color: #333;
        font-size: 3.5vw;
        text-transform: uppercase;
    }

    .data-container td {
        background-color: #eaeaea;
        font-size: 3vw;
        color: #333;
    }

    .data-container .power-on {
        color: #27AE60;
    }

    .data-container .power-off {
        color: #666;
    }

    .credits-footer {
        display: flex;
        justify-content: space-between;
        padding-top: 2vw;
        align-items: center;
        background-color: #f5f5f5;
    }

    .credits-text-left,
    .credits-text-right {
        margin: 0;
        color: #333;
    }

    .device-data-card {
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 30px;
        /* increased padding */
        margin: 20px auto;
        max-width: 100%;
        /* increased width */
        transition: transform 0.3s ease-in-out;
        /* smooth transition for hover effect */
    }

    .device-data-card:hover {
        transform: scale(1.05);
        /* subtle zoom effect on hover */
    }

    .device-data-card>div {
        margin-bottom: 20px;
        /* increased spacing */
        padding: 10px;
        /* added padding for each section */
        background: #ffffff;
        /* different background for each section */
        border-radius: 5px;
        /* rounded corners for sections */
    }

    .device-data-card>div:last-child {
        margin-bottom: 0;
    }

    .device-data-card span {
        font-weight: 600;
        /* bolder font for emphasis */
        font-size: 1.1em;
        /* larger font size */
        display: inline-block;
        /* block level allows for more control */
        margin-left: 5px;
        /* spacing between label and value */
    }

    .device-info {
        font-size: 1.4em;
        /* increased size for device info */
        color: #333;
        font-weight: 700;
        /* make it bolder */
        margin-bottom: 25px;
        /* extra spacing */
    }

    .last-price-fetch,
    .daily-average-price,
    .your-average-price,
    .your-savings {
        color: #333;
        /* darker font color for better readability */
        font-size: 1.2em;
        /* larger font size */
        background: #f0f0f0;
        /* light grey background for sections */
    }

    .your-savings span {
        color: #4CAF50;
        /* keep the savings in green for visual emphasis */
        font-size: 1.3em;
        /* slightly larger font for savings value */
    }


    /* ... [your existing CSS above this comment] ... */

    /* Media Query for Desktop and Large Screens */
    @media (min-width: 1024px) {
        #msform {
            max-width: 60vw;
            margin: 2vw auto;
        }

        #msform input,
        #msform textarea {
            font-size: 1.5vw;
            padding: 0.5vw;
            border: 0.2vw solid #bbb;
            border-radius: 0.3vw;
        }

        #msform label {
            font-size: 1.5vw;
            padding-top: 1vw;
        }

        select#device-selector {
            font-size: 2vw;
            padding: 1vw;
        }

        #msform button {
            font-size: 1.5vw;
            padding: 2vw;
            margin-bottom: 5vw;
            margin-top: 2vw;
        }

        .fs-title {
            font-size: 3vw;
        }

        .fs-subtitle {
            font-size: 1.5vw;
            padding: 2vw;
        }

        #progressbar li {
            font-size: 1vw;
        }

        #progressbar li:before {
            font-size: 2vw;
            height: 3vw;
            line-height: 3vw;
        }

        .data-container th,
        .data-container td {
            padding: 0.3vw;
        }

        .data-container th {
            font-size: 1.5vw;
        }

        .data-container td {
            font-size: 1.3vw;
        }
    }
</style>

<!-- multistep form -->
<div id="msform">
    <!-- Add this right above your <form> -->
    <h3 id="title" class="fs-subtitle">No device is selected. Select one from below. </h3>
    <!-- fieldsets -->
    <div id="fieldsets">
        <fieldset>
            <div class="data-container">
                <div id="yesterday-data"></div>
            </div>
        </fieldset>
        <fieldset class="current">
            <div class="data-container">
                <div id="today-data"></div>
            </div>
        </fieldset>
        <fieldset>
            <div class="data-container">
                <div id="tomorrow-data"></div>
            </div>
        </fieldset>
    </div>
    <!-- progressbar -->
    <ul id="progressbar">
        <li id="yesterday-menu">Yesterday</li>
        <li class="active" id="today-menu">Today</li>
        <li id="tomorrow-menu">Tomorrow</li>
    </ul>
</div>
<script>

    // Function to update active class on progress bar items
    function updateActiveProgress(activeMenuId) {
        document.querySelectorAll("#progressbar li").forEach(function (menuItem) {
            menuItem.classList.remove("active");
        });
        document.getElementById(activeMenuId).classList.add("active");
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Function to hide all fieldsets and then show the selected one


        // Event listener for the "Yesterday" menu item
        document.getElementById("yesterday-menu").addEventListener("click", function () {

            updateActiveProgress("yesterday-menu");
            document.getElementById('yesterday-data').style.display = 'block';
            document.getElementById('today-data').style.display = 'none';
            document.getElementById('tomorrow-data').style.display = 'none';
        });

        // Event listener for the "Today" menu item
        document.getElementById("today-menu").addEventListener("click", function () {

            updateActiveProgress("today-menu");
            document.getElementById('yesterday-data').style.display = 'none';
            document.getElementById('today-data').style.display = 'block';
            document.getElementById('tomorrow-data').style.display = 'none';

        });

        // Event listener for the "Tomorrow" menu item
        document.getElementById("tomorrow-menu").addEventListener("click", function () {

            updateActiveProgress("tomorrow-menu");
            document.getElementById('yesterday-data').style.display = 'none';
            document.getElementById('today-data').style.display = 'none';
            document.getElementById('tomorrow-data').style.display = 'block';
        });
        document.getElementById('yesterday-data').style.display = 'none';
        document.getElementById('today-data').style.display = 'block';
        document.getElementById('tomorrow-data').style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', () => {
        const listItems = document.querySelectorAll('#progressbar li');
        const dateOffsets = [-1, 0, 1];  // Yesterday, today, and tomorrow

        listItems.forEach((li, index) => {
            if (index < dateOffsets.length) {
                const date = new Date();
                date.setDate(date.getDate() + dateOffsets[index]);
                const day = String(date.getDate());
                const month = String(date.getMonth() + 1);
                const formattedDate = `"${day}.${month}"`;  // Quote the string for valid CSS content
                li.style.setProperty('--date', formattedDate);
            }
        });
    });
    const translations = {
        english: {
            "title": "No device is selected. Select or add a device from above.",
            "yesterday-menu": "Yesterday",
            "today-menu": "Today",
            "tomorrow-menu": "Tomorrow",
            "device-selection-text": "Select device",
            "add-device-text": "Add device",
            "device-name-label": "Name your device",
            "device-name-prefilled": "Kitchen radiator",
            "device-code-label": "Device code:",
            "cancel-device": "Cancel",
            "submit-device": "Save",
            "time": "Time",
            "price": "Price",
            "power": "Power",
            "on": "On",
            "off": "Off",
            "today-at": "today at ",
            "today": "today.",
            "yesterday-at": "yesterday at ",
            "yesterday": "yesterday.",
            "last-price-fetch": "Last price fetch ",
            "days-ago": "-days ago",
            "days-ago-at": "-days ago at ",
            "daily-average-price": "Daily average price",
            "your-average-price": "Your average price",
            "your-savings": "Your savings",
            "device-info": "Device info",
            "come-back-later": "Prices are annouced today at 13:00 CET."
        },
        finnish: {
            "title": "Ei laitetta valittuna. Valitse tai lisää laite yläpuolella olevasta valikosta.",
            "yesterday-menu": "Eilen",
            "today-menu": "Tänään",
            "tomorrow-menu": "Huomenna",
            "device-selection-text": "Valitse laite",
            "add-device-text": "Lisää laite",
            "device-name-label": "Nimeä laitteesi",
            "device-name-prefilled": "Keittiön lämpöpatteri",
            "device-code-label": "Laitekoodi:",
            "cancel-device": "Peruuta",
            "submit-device": "Tallenna",
            "time": "Aika",
            "price": "Hinta",
            "power": "Virta",
            "on": "Päällä",
            "off": "Pois",
            "today": "Tänään",
            "today-at": "Tänään klo ",
            "yesterday-at": "Eilen klo. ",
            "yesterday": "Eilen.",
            "last-price-fetch": "Viimeisin hinta haettu ",
            "days-ago": "-päivää sitten",
            "days-ago-at": "-päivää sitten klo. ",
            "daily-average-price": "Päivän keskihinta",
            "your-average-price": "Sinun keskihintasi",
            "your-savings": "Säästösi",
            "device-info": "Laitteen tiedot",
            "come-back-later": "Hinnat julkaistaan tänään klo. 14:00 Nordpool sähköpörssin sulkeuduttua."
        },
        // add translations
    };


    function getBrowserLanguage() {
        const browserLanguage = navigator.language || navigator.userLanguage;
        const languageMap = {
            'en': 'english',
            'fi': 'finnish',
            'fr': 'french',
            'de': 'german',
            'it': 'italian',
            'es': 'spanish',
            'pt': 'portuguese',
            'nl': 'dutch',
            'sv': 'swedish',
            'da': 'danish',
            'no': 'norwegian',
            'lt': 'lithuanian',
            'lv': 'latvian',
            'et': 'estonian',
        };
        const prefix = browserLanguage.slice(0, 2); // get the first two characters of the language code
        return languageMap[prefix] || 'english'; // Default to English if language isn't in the map
    }

    function updateFormLanguage() {
        const selectedLanguage = getBrowserLanguage();
        const translation = translations[selectedLanguage];

        // Update the languge of the website
        document.getElementById("yesterday-menu").textContent = translation["yesterday-menu"];
        document.getElementById("today-menu").textContent = translation["today-menu"];
        document.getElementById("tomorrow-menu").textContent = translation["tomorrow-menu"];

        document.getElementById("title").textContent = translation["title"];

    }

    // Call the updateFormLanguage() function to initially set the language
    updateFormLanguage();

    document.addEventListener("DOMContentLoaded", function () {

        function calculateAverage(prices) {
            const sum = prices.reduce((acc, price) => acc + price, 0);
            return prices.length > 0 ? sum / prices.length : 0;
        }

        function calculateNthCheapestPrice(prices, n) {
            const sortedPrices = [...prices].sort((a, b) => a - b);
            return sortedPrices[n - 1] || 0;
        }

        // Function to retrieve price data
        function fetchPriceData() {
        
                // Make the API request
                const response = {
                "2024052501": 0.76, "2024052502": 0.77, "2024052503": 0.75, "2024052504": 0.78, "2024052505": 0.81,
                "2024052506": 0.87, "2024052507": 1.27, "2024052508": 2.09, "2024052509": 2.59, "2024052510": 2.54,
                "2024052511": 1.88, "2024052512": 1.13, "2024052513": 0.4, "2024052514": 0.0, "2024052515": 0.0,
                "2024052516": 0.13, "2024052517": 1.44, "2024052518": 1.95, "2024052519": 2.23, "2024052520": 1.89,
                "2024052521": 1.33, "2024052522": 0.67, "2024052523": 0.48, "2024052600": 0.3, "2024052601": 0.2,
                "2024052602": 0.24, "2024052603": 0.25, "2024052604": 0.25, "2024052605": 0.28, "2024052606": 0.31,
                "2024052607": 0.38, "2024052608": 0.56, "2024052609": 0.88, "2024052610": 0.15, "2024052611": 0.0,
                "2024052612": -0.01, "2024052613": -0.26, "2024052614": -0.75, "2024052615": -0.63, "2024052616": -0.35,
                "2024052617": 0.15, "2024052618": 1.12, "2024052619": 1.5, "2024052620": 1.56, "2024052621": 0.95,
                "2024052622": 0.57, "2024052623": 0.35, "2024052700": 0.11, "2024052701": -0.21, "2024052702": -0.21,
                "2024052703": -0.22, "2024052704": -0.19, "2024052705": -0.02, "2024052706": 0.05, "2024052707": 0.36,
                "2024052708": 0.96, "2024052709": 1.48, "2024052710": 0.97, "2024052711": 0.52, "2024052712": 0.34,
                "2024052713": 0.21, "2024052714": 0.18, "2024052715": 0.19, "2024052716": 0.22, "2024052717": 0.29,
                "2024052718": 0.44, "2024052719": 0.52, "2024052720": 0.53, "2024052721": 0.46, "2024052722": 0.34,
                "2024052723": 0.17, "2024052800": -0.0, "2024052801": -0.13, "2024052802": -0.21, "2024052803": -0.25,
                "2024052804": -0.25, "2024052805": -0.12, "2024052806": 0.1, "2024052807": 0.48, "2024052808": 1.58,
                "2024052809": 1.94, "2024052810": 1.74, "2024052811": 1.01, "2024052812": 0.6, "2024052813": 0.47,
                "2024052814": 0.35, "2024052815": 0.28, "2024052816": 0.28, "2024052817": 0.36, "2024052818": 0.6,
                "2024052819": 0.93, "2024052820": 1.55, "2024052821": 1.2, "2024052822": 0.98, "2024052823": 0.56,
                "2024052900": 0.28, "offset_hour": 3.0
            }
                // Parse the JSON data from the response
                return response.json();
        }

        function formatDate(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0'); // January is 0!
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}${mm}${dd}`;
        }

        function formatRelativeTime(timestamp) {
            // Parse the timestamp
            const year = parseInt(timestamp.substring(0, 4), 10);
            const month = parseInt(timestamp.substring(4, 6), 10) - 1; // JS months are 0-indexed
            const day = parseInt(timestamp.substring(6, 8), 10);
            const hour = timestamp.length >= 10 ? parseInt(timestamp.substring(8, 10), 10) : null;
            // Set minutes to "00" if the timestamp includes hours but no minutes
            const minute = timestamp.length === 12 ? parseInt(timestamp.substring(10, 12), 10) : (timestamp.length === 10 ? 0 : null);

            // Create date object from timestamp
            const timestampDate = new Date(year, month, day, hour ?? 0, minute ?? 0);

            // Get current date and reset hours for accurate day comparison
            const currentDate = new Date();
            const today = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Compare dates
            const timestampDay = new Date(year, month, day);
            const daysDiff = Math.round((today - timestampDay) / (1000 * 60 * 60 * 24));

            let relativeDateString;

            const selectedLanguage = getBrowserLanguage();
            const translation = translations[selectedLanguage];

            if (daysDiff === 0) {
                // Today
                relativeDateString = hour !== null ? `${translation["today-at"]}${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}` : translation["today"];
            } else if (daysDiff === 1) {
                // Yesterday
                relativeDateString = hour !== null ? `${translation["yesterday-at"]}${hour.toString().padStart(2, '0')}:${minute ? minute.toString().padStart(2, '0') : '00'}` : translation["yesterday"];
            } else {
                // More than one day ago
                relativeDateString = `${daysDiff}${translation["days-ago"]}`;
            }

            return relativeDateString;
        }

        // Function to generate the table HTML
        function generateTableHTML(prices, kwhTrigger, cheapestHours, dayAverage, onHoursAverage, timestamp) {

            const selectedLanguage = getBrowserLanguage();
            const translation = translations[selectedLanguage];

            const times = Array.from({ length: 24 }, (_, i) => `${i}-${i + 1}`);

            // Identify the Nth cheapest price
            const sortedPrices = [...prices].sort((a, b) => a - b);
            const thCheapestPrice = sortedPrices[cheapestHours - 1] || 0;

            const rows = times.map((time, index) => {
                const price = prices[index] || 0;

                let power;
                if (price < kwhTrigger || price <= thCheapestPrice) {
                    power = 'on';
                } else {
                    power = 'off';
                }

                const powerClass = power === 'on' ? 'power-on' : 'power-off';
                if (power == 'on') {
                    power = translation["on"];
                }
                else {
                    power = translation["off"];
                }

                return [time, price, power, powerClass];
            });

            // Calculate the discount percentage
            const discountPercentage = ((dayAverage - onHoursAverage) / dayAverage) * 100;

            // Add rows for average prices
            const deviceInfoHTML = `
            <div class="device-data-card">
                <div class="device-info">${translation["device-info"]}</div>
                <div class="last-price-fetch">
                    ${translation["last-price-fetch"]}: <span>${formatRelativeTime(timestamp)}</span>
                </div>
                <div class="daily-average-price">
                    ${translation["daily-average-price"]}: <span>${dayAverage.toFixed(2)}</span>
                </div>
                <div class="your-average-price">
                    ${translation["your-average-price"]}: <span>${onHoursAverage.toFixed(2)}</span>
                </div>
                <div class="your-savings">
                    ${translation["your-savings"]}: <span>${discountPercentage.toFixed(2)}%</span>
                </div>
            </div>
            `;

            const tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>${translation["time"]}</th>
                                <th>${translation["price"]}</th>
                                <th>${translation["power"]}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(row => `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${row[1]}</td>
                                <td class="${row[3]}">${row[2]}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${deviceInfoHTML}
                `;

            return tableHTML;
        }



        function updateData() {

            const trigger = 1;
            const hours = 3

            fetchPriceData().then(data => {
                if (data) {
                    // Get formatted date strings
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);

                    const todayStr = formatDate(today);
                    const yesterdayStr = formatDate(yesterday);
                    const tomorrowStr = formatDate(tomorrow);

                    // Filter values based on dates
                    const yesterdayData = Object.entries(data)
                        .filter(([key,]) => key.startsWith(yesterdayStr))
                        .map(([key, value]) => value)

                    const todayData = Object.entries(data)
                        .filter(([key,]) => key.startsWith(todayStr))
                        .map(([key, value]) => value)

                    const tomorrowData = Object.entries(data)
                        .filter(([key,]) => key.startsWith(tomorrowStr))
                        .map(([key, value]) => value)

                    // Inside updateData function, after fetching the data
                    const thCheapestPriceToday = calculateNthCheapestPrice(todayData, hours);
                    const onHoursDataToday = todayData.filter(price => price < trigger || price <= thCheapestPriceToday);
                    const onHoursAverageToday = calculateAverage(onHoursDataToday);

                    // Similar calculations for yesterday and tomorrow
                    const thCheapestPriceYesterday = calculateNthCheapestPrice(yesterdayData, hours);
                    const onHoursDataYesterday = yesterdayData.filter(price => price < trigger || price <= thCheapestPriceYesterday);
                    const onHoursAverageYesterday = calculateAverage(onHoursDataYesterday);

                    const thCheapestPriceTomorrow = calculateNthCheapestPrice(tomorrowData, hours);
                    const onHoursDataTomorrow = tomorrowData.filter(price => price < trigger || price <= thCheapestPriceTomorrow);
                    const onHoursAverageTomorrow = calculateAverage(onHoursDataTomorrow);


                    // Update the DOM
                    document.getElementById('title').style.display = 'none';

                    const selectedLanguage = getBrowserLanguage();
                    const translation = translations[selectedLanguage];

                    document.getElementById("yesterday-data").innerHTML = generateTableHTML(yesterdayData, trigger, hours, calculateAverage(yesterdayData), onHoursAverageYesterday, timestamp);
                    document.getElementById("today-data").innerHTML = generateTableHTML(todayData, trigger, hours, calculateAverage(todayData), onHoursAverageToday, timestamp);
                    if (12 < today.getUTCHours()) {
                        document.getElementById("tomorrow-data").innerHTML = generateTableHTML(tomorrowData, trigger, hours, calculateAverage(tomorrowData), onHoursAverageTomorrow, timestamp);
                    }
                    else {
                        document.getElementById("tomorrow-data").innerHTML = `<h3 class="fs-subtitle">${translation["come-back-later"]}</h3>`;
                    }
                }
            });
        }
    });
</script>