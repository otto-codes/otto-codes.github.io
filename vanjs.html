<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powerant App: Smart Electricity Price Control</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.jade.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.5.0.nomodule.min.js"></script>
    <style>
        :root {
            --background-color: var(--pico-background-color, #f8f9fa);
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
        }
        .logo {
            display: block;
            margin: 0 auto;
            max-width: 100px;
            margin-bottom: 20px;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #333;
            color: white;
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar .logo {
            margin-bottom: 10px;
        }
        .hamburger {
            position: absolute;
            top: 20px;
            left: 20px;
            cursor: pointer;
            z-index: 1000;
        }
        .hamburger span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: #333;
            margin: 5px 0;
        }
        .splash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .splash.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <div id="hamburger" class="hamburger" onclick="toggleSidebar()" style="display: none;">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div id="sidebar" class="sidebar">
        <img src="powerant-logo-small2.png" alt="PowerAnt Logo" class="logo">
        <h2>Powerant</h2>
        <p>Hello, <span id="sidebarUserEmail"></span>!</p>
        <button onclick="logout()">Logout</button>
    </div>
    <main class="container">
        <div id="splash" class="splash hidden">
            <img src="powerant-logo-small2.png" alt="PowerAnt Logo" class="logo">
            <h2 id="welcomeMessage">Welcome back</h2>
        </div>
        <div id="app"></div>
    </main>
    <script>
        const { div, form, input, button, h2, p, nav, ul, li, a, img, select, option, h3, h1 } = van.tags;

        const loginUser = async (email, password) => {
            try {
                const response = await fetch('https://api2.powerant.eu/api/collections/users/auth-with-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ identity: email, password: password })
                });
                if (!response.ok) throw new Error('Login failed');
                const data = await response.json();
                localStorage.setItem('jwt', data.token);
                localStorage.setItem('userEmail', email);
                return data.token;
            } catch (error) {
                throw new Error(error.message);
            }
        };

        const parseJwt = (token) => {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                return null;
            }
        };

        const checkJwt = async () => {
            const token = localStorage.getItem('jwt');
            if (!token) return false;

            const decodedToken = parseJwt(token);
            if (!decodedToken) return false;

            const currentTime = Math.floor(Date.now() / 1000);
            const tokenExpiryTime = decodedToken.exp;

            if (tokenExpiryTime - currentTime < 300) {
                try {
                    const response = await fetch('https://api2.powerant.eu/api/collections/users/auth-refresh', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (!response.ok) throw new Error('Invalid token');
                    const data = await response.json();
                    localStorage.setItem('jwt', data.token);
                    return data.token;
                } catch (error) {
                    return false;
                }
            }

            return token;
        };

        const fetchDevices = async (token) => {
            try {
                const response = await fetch('https://api2.powerant.eu/api/collections/legacy_devices/records', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch devices');
                const data = await response.json();
                return data.items || [];
            } catch (error) {
                console.error(error);
                return [];
            }
        };

        const fetchDeviceData = async (token, deviceId) => {
            try {
                const response = await fetch(`https://api2.powerant.eu/api/collections/legacy_devices/records/${deviceId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch device data');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(error);
                return null;
            }
        };

        const toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('open');
        };

        const logout = () => {
            localStorage.clear();
            window.location.reload();
        };

        const LoginPage = (isLoggedIn, userEmail, devices) => {
            const email = van.state('');
            const password = van.state('');
            const message = van.state('');

            const login = async (e) => {
                e.preventDefault();
                try {
                    const token = await loginUser(email.val, password.val);
                    message.val = 'Login successful!';
                    isLoggedIn.val = true;
                    userEmail.val = email.val;
                    devices.val = await fetchDevices(token);
                    document.getElementById('sidebarUserEmail').textContent = email.val;
                    showSplashScreen(email.val);
                } catch (error) {
                    message.val = error.message;
                }
            };

            return form({ onsubmit: login },
                img({ src: 'powerant-logo-small2.png', alt: 'PowerAnt Logo', class: 'logo' }),
                h2('Login'),
                input({ type: 'email', placeholder: 'Email', value: email, oninput: e => email.val = e.target.value, required: true }),
                input({ type: 'password', placeholder: 'Password', value: password, oninput: e => password.val = e.target.value, required: true }),
                button({ type: 'submit' }, 'Login'),
                p({ style: 'color: red;' }, message)
            );
        };

        const SignupPage = (isLoggedIn, userEmail, devices) => {
            const email = van.state('');
            const password = van.state('');
            const message = van.state('');

            const signup = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('https://api2.powerant.eu/api/collections/users/records', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: email.val, password: password.val, passwordConfirm: password.val })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        if (data?.data?.email?.message) {
                            message.val = data.data.email.message;
                        } else {
                            throw new Error('Sign-up failed');
                        }
                    } else {
                        message.val = 'Sign-up successful!';
                        const token = await loginUser(email.val, password.val);
                        isLoggedIn.val = true;
                        userEmail.val = email.val;
                        devices.val = await fetchDevices(token);
                        document.getElementById('sidebarUserEmail').textContent = email.val;
                        showSplashScreen(email.val);
                    }
                } catch (error) {
                    message.val = error.message;
                }
            };

            return form({ onsubmit: signup },
                img({ src: 'powerant-logo-small2.png', alt: 'PowerAnt Logo', class: 'logo' }),
                h2('Sign-Up'),
                input({ type: 'email', placeholder: 'Email', value: email, oninput: e => email.val = e.target.value, required: true }),
                input({ type: 'password', placeholder: 'Password', value: password, oninput: e => password.val = e.target.value, required: true }),
                button({ type: 'submit' }, 'Sign-Up'),
                p({ style: 'color: red;' }, message)
            );
        };

        const DevicesPage = (devices, selectedDevice, onDeviceSelect) => {
            return div(
                h2('My Devices'),
                ul(
                    devices.map(device =>
                        li(a({ href: '#', onclick: e => { e.preventDefault(); onDeviceSelect(device.id); } }, device.device_name))
                    )
                ),
                selectedDevice.val && DeviceData(selectedDevice.val)
            );
        };

        const DeviceData = (deviceData) => {
            return div(
                h3(`Device Name: ${deviceData.device_name}`),
                p(`Device ID: ${deviceData.id}`),
                p(`Description: ${deviceData.description || 'N/A'}`),
                p(`Device Action: ${deviceData.device_action}`),
                p(`Price Trigger: ${deviceData.price_trigger}`),
                p(`Cheapest Hours: ${deviceData.cheapest_hours}`)
            );
        };

        const App = () => {
            const showLogin = van.state(true);
            const isLoggedIn = van.state(false);
            const userEmail = van.state('');
            const devices = van.state([]);
            const selectedDevice = van.state(null);

            const checkLoginStatus = async () => {
                const token = await checkJwt();
                if (token) {
                    isLoggedIn.val = true;
                    userEmail.val = localStorage.getItem('userEmail');
                    devices.val = await fetchDevices(token);
                    document.getElementById('sidebarUserEmail').textContent = localStorage.getItem('userEmail');
                    showSplashScreen(localStorage.getItem('userEmail'));
                    document.getElementById('hamburger').style.display = 'block';
                }
            };

            const onDeviceSelect = async (deviceId) => {
                const token = localStorage.getItem('jwt');
                if (token) {
                    selectedDevice.val = await fetchDeviceData(token, deviceId);
                }
            };

            checkLoginStatus();

            const switchToLogin = (e) => { e.preventDefault(); showLogin.val = true; };
            const switchToSignup = (e) => { e.preventDefault(); showLogin.val = false; };

            return div(
                () => isLoggedIn.val
                    ? div(
                        DevicesPage(devices.val, selectedDevice, onDeviceSelect)
                    )
                    : div(
                        nav(
                            ul(
                                li(a({ href: '#', onclick: switchToLogin, class: () => showLogin.val ? 'active' : '' }, 'Login')),
                                li(a({ href: '#', onclick: switchToSignup, class: () => !showLogin.val ? 'active' : '' }, 'Sign-Up'))
                            )
                        ),
                        div(
                            () => showLogin.val ? LoginPage(isLoggedIn, userEmail, devices) : SignupPage(isLoggedIn, userEmail, devices)
                        )
                    )
            );
        };

        const showSplashScreen = (email) => {
            document.getElementById('welcomeMessage').textContent = `Welcome back ${email}`;
            const splash = document.getElementById('splash');
            splash.classList.remove('hidden');
            setTimeout(() => {
                splash.classList.add('hidden');
            }, 2000);
        };

        van.add(document.getElementById('app'), App());
    </script>
</body>
</html>
