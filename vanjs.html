<<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powerant App: Smart Electricity Price Control</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.jade.min.css">
    <link rel="stylesheet" href="additional.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.5.0.nomodule.min.js"></script>
</head>
<body>
    <div id="hamburger" class="hamburger" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div id="sidebar" class="sidebar">
        <span class="close-sidebar" onclick="toggleSidebar()">âœ–</span>
        <img src="powerant-logo-small2.png" alt="PowerAnt Logo" class="logo">
        <h2 class="white centered">Powerant</h2>
        <p class="white">Hello, <span class="white" id="sidebarUsername"></span>!</p>
        <button onclick="logout()">Logout</button>
    </div>
    <main class="container">
        <div id="splash" class="splash hidden">
            <img src="powerant-logo-small2.png" alt="PowerAnt Logo" class="logo">
            <h2 id="welcomeMessage">Welcome back</h2>
        </div>
        <div id="app"></div>
    </main>
    <script>
        const { div, form, input, button, h2, p, nav, ul, li, a, img, select, option, h3, h1, span } = van.tags;

        const deviceImages = {
            'xe7fa5ii03fslmj': 'powerant-63A.png',
            '4wlg4fe7371gi32': 'powerant-32A.png'
        };

        const loginUser = async (email, password) => {
            try {
                const response = await fetch('https://api2.powerant.eu/api/collections/users/auth-with-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ identity: email, password: password })
                });
                if (!response.ok) throw new Error('Login failed');
                const data = await response.json();
                localStorage.setItem('jwt', data.token);
                localStorage.setItem('userEmail', email);
                localStorage.setItem('username', data.record.username); // Store username
                return data.token;
            } catch (error) {
                throw new Error(error.message);
            }
        };

        const parseJwt = (token) => {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                return null;
            }
        };

        const checkJwt = async () => {
            const token = localStorage.getItem('jwt');
            if (!token) return false;

            const decodedToken = parseJwt(token);
            if (!decodedToken) return false;

            const currentTime = Math.floor(Date.now() / 1000);
            const tokenExpiryTime = decodedToken.exp;

            if (tokenExpiryTime - currentTime < 300) {
                try {
                    const response = await fetch('https://api2.powerant.eu/api/collections/users/auth-refresh', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (!response.ok) throw new Error('Invalid token');
                    const data = await response.json();
                    localStorage.setItem('jwt', data.token);
                    return data.token;
                } catch (error) {
                    return false;
                }
            }

            return token;
        };

        const fetchDevices = async (token) => {
            try {
                const response = await fetch('https://api2.powerant.eu/api/collections/legacy_devices/records', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch devices');
                const data = await response.json();
                return data.items || [];
            } catch (error) {
                console.error(error);
                return [];
            }
        };

        const fetchDeviceData = async (token, deviceId) => {
            try {
                const response = await fetch(`https://api2.powerant.eu/api/collections/legacy_devices/records/${deviceId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch device data');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(error);
                return null;
            }
        };

        const toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('open');
        };

        const logout = () => {
            localStorage.clear();
            window.location.reload();
        };

        const isConnected = (lastUpdated) => {
            const oneHourAgo = Date.now() - 3600 * 1000;
            return new Date(lastUpdated).getTime() > oneHourAgo;
        };

        const LoginPage = (isLoggedIn, userEmail, username, devices) => {
            const email = van.state('');
            const password = van.state('');
            const message = van.state('');

            const login = async (e) => {
                e.preventDefault();
                try {
                    const token = await loginUser(email.val, password.val);
                    message.val = 'Login successful!';
                    isLoggedIn.val = true;
                    userEmail.val = email.val;
                    username.val = localStorage.getItem('username');
                    devices.val = await fetchDevices(token);
                    document.getElementById('sidebarUsername').textContent = username.val;
                    showSplashScreen(username.val);
                    document.getElementById('hamburger').style.display = 'block';
                } catch (error) {
                    message.val = error.message;
                }
            };

            return form({ onsubmit: login },
                img({ src: 'powerant-logo-small2.png', alt: 'PowerAnt Logo', class: 'logo' }),
                h2('Login'),
                input({ type: 'email', placeholder: 'Email', value: email, oninput: e => email.val = e.target.value, required: true }),
                input({ type: 'password', placeholder: 'Password', value: password, oninput: e => password.val = e.target.value, required: true }),
                button({ type: 'submit' }, 'Login'),
                p({ style: 'color: red;' }, message)
            );
        };

        const SignupPage = (isLoggedIn, userEmail, username, devices) => {
            const name = van.state('');
            const email = van.state('');
            const password = van.state('');
            const message = van.state('');

            const signup = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('https://api2.powerant.eu/api/collections/users/records', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username: name.val, email: email.val, password: password.val, passwordConfirm: password.val })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        if (data?.data?.email?.message) {
                            message.val = data.data.email.message;
                        } else {
                            throw new Error('Sign-up failed');
                        }
                    } else {
                        message.val = 'Sign-up successful!';
                        const token = await loginUser(email.val, password.val);
                        isLoggedIn.val = true;
                        userEmail.val = email.val;
                        username.val = name.val;
                        devices.val = await fetchDevices(token);
                        document.getElementById('sidebarUsername').textContent = name.val;
                        showSplashScreen(name.val);
                        document.getElementById('hamburger').style.display = 'block';
                    }
                } catch (error) {
                    message.val = error.message;
                }
            };

            return form({ onsubmit: signup },
                img({ src: 'powerant-logo-small2.png', alt: 'PowerAnt Logo', class: 'logo' }),
                h2('Sign-Up'),
                input({ type: 'text', placeholder: 'Name', value: name, oninput: e => name.val = e.target.value, required: true }),
                input({ type: 'email', placeholder: 'Email', value: email, oninput: e => email.val = e.target.value, required: true }),
                input({ type: 'password', placeholder: 'Password', value: password, oninput: e => password.val = e.target.value, required: true }),
                button({ type: 'submit' }, 'Sign-Up'),
                p({ style: 'color: red;' }, message)
            );
        };

        const DevicesPage = (devices, onDeviceSelect) => {
            return div(
                h2({ style: 'text-align: center;' },'My Devices'),
                div({ class: 'device-list' },
                    devices.map(device => {
                        const imageUrl = deviceImages[device.device_type] || 'default_image.png';
                        const statusClass = isConnected(device.updated) ? ' connected' : ' disconnected';
                        const statusText = isConnected(device.updated) ? ' Connected' : ' Disconnected';

                        return div({ class: 'device-item', onclick: e => { e.preventDefault(); onDeviceSelect(device.id); } },
                            img({ src: imageUrl, alt: device.device_name }),
                            h3(device.device_name),
                            div({ class: `status-indicator ${statusClass}` }),
                            span({ class: 'status-text' }, statusText)
                        );
                    })
                )
            );
        };

        const DeviceData = (deviceData, onBack) => {
            return div(
                div({ class: 'back-button', onclick: onBack }, 'Back'),
                h3(deviceData.device_name),
                p(`Country/Area: ${deviceData.country_area}`),
                p(`Device Action: ${deviceData.device_action}`),
                p(`Price Trigger: ${deviceData.price_trigger}`),
                p(`Cheapest Hours: ${deviceData.cheapest_hours}`)
            );
        };

        const App = () => {
            const showLogin = van.state(true);
            const isLoggedIn = van.state(false);
            const userEmail = van.state('');
            const username = van.state('');
            const devices = van.state([]);
            const selectedDevice = van.state(null);

            const checkLoginStatus = async () => {
                const token = await checkJwt();
                if (token) {
                    isLoggedIn.val = true;
                    userEmail.val = localStorage.getItem('userEmail');
                    username.val = localStorage.getItem('username');
                    devices.val = await fetchDevices(token);
                    document.getElementById('sidebarUsername').textContent = localStorage.getItem('username');
                    showSplashScreen(localStorage.getItem('username'));
                    document.getElementById('hamburger').style.display = 'block';
                }
            };

            const onDeviceSelect = async (deviceId) => {
                const token = localStorage.getItem('jwt');
                if (token) {
                    selectedDevice.val = await fetchDeviceData(token, deviceId);
                }
            };

            const onBack = () => {
                selectedDevice.val = null;
            };

            checkLoginStatus();

            const switchToLogin = (e) => { e.preventDefault(); showLogin.val = true; };
            const switchToSignup = (e) => { e.preventDefault(); showLogin.val = false; };

            return div(
                () => isLoggedIn.val
                    ? selectedDevice.val
                        ? DeviceData(selectedDevice.val, onBack)
                        : DevicesPage(devices.val, onDeviceSelect)
                    : div(
                        nav(
                            ul(
                                li(a({ href: '#', onclick: switchToLogin, class: () => showLogin.val ? 'active' : '' }, 'Login')),
                                li(a({ href: '#', onclick: switchToSignup, class: () => !showLogin.val ? 'active' : '' }, 'Sign-Up'))
                            )
                        ),
                        div(
                            () => showLogin.val ? LoginPage(isLoggedIn, userEmail, username, devices) : SignupPage(isLoggedIn, userEmail, username, devices)
                        )
                    )
            );
        };

        const showSplashScreen = (username) => {
            document.getElementById('welcomeMessage').textContent = `Welcome back ${username}`;
            const splash = document.getElementById('splash');
            splash.classList.remove('hidden');
            setTimeout(() => {
                splash.classList.add('hidden');
            }, 2000);
        };

        van.add(document.getElementById('app'), App());
    </script>
</body>
</html>
