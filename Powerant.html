<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>Powerant</title>
    <link rel="stylesheet" href="Powerant_tiedostot/styles.css">
    <script src="Powerant_tiedostot/script.js"></script>
</head>

<body>


    <form class="form" action="/submit" method="POST">
        <div style="text-align: right">
            <div class="wifistatus"></div>
            <span onclick="confirmAndDisconnect()" style="display: inline-block; vertical-align: top; color:white"
                ;"="">Tylypahka</span>
        </div>
        <div class="title"><span style="font-weight: bolder;">POWER</span><span style="font-weight: lighter;">ANT</span>
        </div>
        <div id="pricetable">
            <!-- Dropdown menu for date selection -->
            <select id="date-select">
                <option id="yesterday-menu" value="yesterday">Eilen</option>
                <option id="today-menu" value="today" selected="selected">Tänään</option>
                <option id="tomorrow-menu" value="tomorrow">Huomenna</option>
            </select>
            <!-- tables -->
            <div id="price tables">
                <div>
                    <div class="prices-container">
                        <div id="yesterday-data"></div>
                    </div>
                </div>
                <div class="current">
                    <div class="prices-container">
                        <div id="today-data">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-translate="Hour">Tunti</th>
                                        <th data-translate="Price">Hinta</th>
                                        <th data-translate="Electricity">Sähkö</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0-1</td>
                                        <td>0.28</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>1-2</td>
                                        <td>0.11</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>2-3</td>
                                        <td>0.10</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>3-4</td>
                                        <td>0.11</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>4-5</td>
                                        <td>0.14</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>5-6</td>
                                        <td>0.24</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>6-7</td>
                                        <td>0.37</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>7-8</td>
                                        <td>2.23</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>8-9</td>
                                        <td>7.69</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>9-10</td>
                                        <td>11.38</td>
                                        <td><span class="power-off">Pois</span></td>
                                    </tr>
                                    <tr>
                                        <td>10-11</td>
                                        <td>10.95</td>
                                        <td><span class="power-off">Pois</span></td>
                                    </tr>
                                    <tr>
                                        <td>11-12</td>
                                        <td>8.43</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>12-13</td>
                                        <td>7.71</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>13-14</td>
                                        <td>7.32</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>14-15</td>
                                        <td>7.71</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>15-16</td>
                                        <td>5.21</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>16-17</td>
                                        <td>24.80</td>
                                        <td><span class="power-off">Pois</span></td>
                                    </tr>
                                    <tr>
                                        <td>17-18</td>
                                        <td>30.99</td>
                                        <td><span class="power-off">Pois</span></td>
                                    </tr>
                                    <tr>
                                        <td>18-19</td>
                                        <td>6.56</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>19-20</td>
                                        <td>14.46</td>
                                        <td><span class="power-off">Pois</span></td>
                                    </tr>
                                    <tr>
                                        <td>20-21</td>
                                        <td>10.40</td>
                                        <td><span class="power-off">Pois</span></td>
                                    </tr>
                                    <tr>
                                        <td>21-22</td>
                                        <td>7.59</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>22-23</td>
                                        <td>4.60</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                    <tr>
                                        <td>23-24</td>
                                        <td>0.63</td>
                                        <td><span class="power-on">Päällä</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="prices-container">
                        <div id="tomorrow-data"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="subtitle" id="subtitle">Määritä laitteesi:</div>
        <div class="button-container">
            <!-- Change type to 'button' to prevent form submission -->
            <button type="button" id="offButton" data-action="Off" class="off"
                onclick="updateStatus(event, 'Off')">Pois</button>
            <button type="button" id="autoButton" data-action="Automatic" class="auto active"
                onclick="updateStatus(event, 'Automatic')">Automaattinen</button>
            <button type="button" id="onButton" data-action="On" class="on"
                onclick="updateStatus(event, 'On')">Päällä</button>
        </div>
        <div class="input-container ic4">
            <select class="input" id="country" name="country">
                <option value="austria-at1">Austria</option>
                <option value="belgium-be1">Belgium</option>
                <option value="bulgaria-bg1">Bulgaria</option>
                <option value="croatia-hr1">Croatia</option>
                <option value="czech-republic-cz1">Czech Republic</option>
                <option value="denmark-dk1">Denmark DK1</option>
                <option value="denmark-dk2">Denmark DK2</option>
                <option value="estonia-ee1">Estonia</option>
                <option value="finland-fi1" selected="selected">Finland</option>
                <option value="france-fr1">France</option>
                <option value="germany-de1">Germany</option>
                <option value="greece-gr1">Greece</option>
                <option value="hungary-hu1">Hungary</option>
                <option value="ireland-ie1">Ireland</option>
                <option value="italy-calabria">Italy Calabria</option>
                <option value="italy-centre-north">Italy Centre-North</option>
                <option value="italy-centre-south">Italy Centre-South</option>
                <option value="italy-north">Italy North</option>
                <option value="italy-sacoac">Italy SACOAC</option>
                <option value="italy-sacodc">Italy SACODC</option>
                <option value="italy-sardinia">Italy Sardinia</option>
                <option value="italy-sicily">Italy Sicily</option>
                <option value="italy-south">Italy South</option>
                <option value="latvia-lv1">Latvia</option>
                <option value="lithuania-lt1">Lithuania</option>
                <option value="netherlands-nl1">Netherlands</option>
                <option value="norway-no1">Norway NO1</option>
                <option value="norway-no2">Norway NO2</option>
                <option value="norway-no3">Norway NO3</option>
                <option value="norway-no4">Norway NO4</option>
                <option value="norway-no5">Norway NO5</option>
                <option value="poland-pl1">Poland</option>
                <option value="portugal-pt1">Portugal</option>
                <option value="romania-ro1">Romania</option>
                <option value="serbia-rs1">Serbia</option>
                <option value="spain-es1">Spain</option>
                <option value="sweden-se1">Sweden SE1</option>
                <option value="sweden-se2">Sweden SE2</option>
                <option value="sweden-se3">Sweden SE3</option>
                <option value="sweden-se4">Sweden SE4</option>
            </select>
            <div class="cut cut-short"></div>

            <label for="country" class="placeholder country" id="countryLabel">Maa/Alue:</label>
        </div>
        <div class="input-container ic5">
            <select id="hours" name="hours" class="input">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18" selected="selected">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
            </select>
            <div class="cut cut-short"></div>
            <label for="hours" class="placeholder hours" id="hoursLabel">Halvimmat tunnit</label>
        </div>
        <div class="input-container ic6">
            <input type="number" id="maxprice" name="maxprice" class="input" value="5" step="0.01">
            <div class="cut cut-short"></div>
            <label for="maxprice" class="placeholder maxprice" id="maxpriceLabel">Hintakatto</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="show-settings" name="show-settings" onchange="toggleSettings()">
            <label for="show-settings" class="checkbox-label" id="settingsLabel">Näytä lisäasetukset:</label>
        </div>
        <div id="additional-settings" style="display:none;">
            <div class="input-container ic3">
                <label class="checkbox-label" id="keyStatus">Tuoteavain: </label><span
                    class="checkbox-label">ddd-ddd-ddd-ddd</span> <br>
                <label class="checkbox-label" id="ip-label">IP Address: </label><span
                    class="checkbox-label">192.168.68.106</span>
            </div>
            <div class="input-container ic7">
                <input type="text" id="static-ip" name="static-ip" class="input">
                <div class="cut"></div>
                <label for="static-ip" class="placeholder staticip" id="ipLabel">Staattinen IP-osoite</label>
            </div>
            <div class="input-container ic8">
                <input type="text" id="server-address" name="server-address" class="input">
                <div class="cut"></div>
                <label for="server-address" class="placeholder server" id="serverLabel">Palvelimen osoite</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="configure-lan" name="configure-lan" value="on" onchange="toggleLANFields()">
                <label for="configure-lan" class="checkbox-label" id="lanConfigLabel">Määritä LAN:n kautta:</label>
            </div>
            <div id="lan-fields" style="display:none;">
                <div class="input-container ic8">
                    <input type="text" id="lan-username" name="lan-username" class="input">
                    <div class="cut"></div>
                    <label for="lan-username" class="placeholder lanuser" id="lanUserLabel">LAN-käyttäjätunnus</label>
                </div>
                <div class="input-container ic10">
                    <input type="password" id="lan-password" name="lan-password" class="input" value="">
                    <div class="cut"></div>
                    <label for="lan-password" class="placeholder lanpassword" id="lanPasswordLabel">LAN-salasana</label>
                </div>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="remote-control" name="remote-control" value="on"
                    onchange="toggleAppFields()">
                <label for="remote-control" class="checkbox-label" id="remoteControlLabel">Etäohjaus
                    Powerant-sovelluksella:</label>
            </div>
        </div>
        <input type="submit" class="submit" value="Tallenna" id="saveButton">
    </form>
    <footer>
        <script>
            let currentStatus = 'Automatic'; // Initial status loaded with the page

            function setActiveButton(action) {
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (btn.dataset.action === action) { // Use the passed action for comparison
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            function updateStatus(event, action) {
                event.preventDefault();  // Prevent form submission

                // Update global currentStatus with the new action
                currentStatus = action;

                // Call setActiveButton with the updated status
                setActiveButton(currentStatus);

                // Encode the currentStatus to ensure it's correctly formatted for a URL
                const data = "deviceAction=" + encodeURIComponent(currentStatus);

                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/submit", true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.send(data); // Send the data including the currentStatus
            }

            window.onload = function () {
                setActiveButton(currentStatus); // Set the correct active button when the page loads
            };
            const priceData = { "2024052701": -0.21, "2024052702": -0.21, "2024052703": -0.22, "2024052704": -0.19, "2024052705": -0.02, "2024052706": 0.05, "2024052707": 0.36, "2024052708": 0.96, "2024052709": 1.48, "2024052710": 0.97, "2024052711": 0.52, "2024052712": 0.34, "2024052713": 0.21, "2024052714": 0.18, "2024052715": 0.19, "2024052716": 0.22, "2024052717": 0.29, "2024052718": 0.44, "2024052719": 0.52, "2024052720": 0.53, "2024052721": 0.46, "2024052722": 0.34, "2024052723": 0.17, "2024052800": -0.0, "2024052801": -0.13, "2024052802": -0.21, "2024052803": -0.25, "2024052804": -0.25, "2024052805": -0.12, "2024052806": 0.1, "2024052807": 0.48, "2024052808": 1.58, "2024052809": 1.94, "2024052810": 1.74, "2024052811": 1.01, "2024052812": 0.6, "2024052813": 0.47, "2024052814": 0.35, "2024052815": 0.28, "2024052816": 0.28, "2024052817": 0.36, "2024052818": 0.6, "2024052819": 0.93, "2024052820": 1.55, "2024052821": 1.2, "2024052822": 0.98, "2024052823": 0.56, "2024052900": 0.28, "2024052901": 0.11, "2024052902": 0.1, "2024052903": 0.11, "2024052904": 0.14, "2024052905": 0.24, "2024052906": 0.37, "2024052907": 2.23, "2024052908": 7.69, "2024052909": 11.38, "2024052910": 10.95, "2024052911": 8.43, "2024052912": 7.71, "2024052913": 7.32, "2024052914": 7.71, "2024052915": 5.21, "2024052916": 24.8, "2024052917": 30.99, "2024052918": 6.56, "2024052919": 14.46, "2024052920": 10.4, "2024052921": 7.59, "2024052922": 4.6, "2024052923": 0.63, "2024053000": 0.38, "2024053001": 0.23, "2024053002": 0.13, "2024053003": 0.15, "2024053004": 0.22, "2024053005": 0.33, "2024053006": 0.65, "2024053007": 7.44, "2024053008": 17.61, "2024053009": 13.21, "2024053010": 17.61, "2024053011": 17.61, "2024053012": 12.4, "2024053013": 13.63, "2024053014": 17.5, "2024053015": 24.8, "2024053016": 17.93, "2024053017": 22.25, "2024053018": 24.23, "2024053019": 30.99, "2024053020": 21.46, "2024053021": 7.56, "2024053022": 5.29, "2024053023": 1.86, "2024053100": 0.75, "offset_hour": 3.0 };
            const priceTrigger = 5; // Price below which the device is considered ON
            const cheapestHours = 18; // Number of hours when the device should be ON at the cheapest rates

            function calculateCheapestHours(data, count) {
                return Object.entries(data)
                    .sort((a, b) => a[1] - b[1])
                    .slice(0, count)
                    .reduce((acc, [key,]) => ({ ...acc, [key]: true }), {});
            }

            // Default user language detection
            const userLang = (navigator.language || navigator.userLanguage).substring(0, 2); // Detect browser language once
            let currentTranslations = {}; // Cache for storing current translations

            // Translation dictionary
            const translations = {
                'Yesterday': {
                    'fi': 'Eilen',
                    'sv': 'Igår',
                    'no': 'I går'
                },
                'Today': {
                    'fi': 'Tänään',
                    'sv': 'Idag',
                    'no': 'I dag'
                },
                'Tomorrow': {
                    'fi': 'Huomenna',
                    'sv': 'Imorgon',
                    'no': 'I morgen'
                },
                'Hour': {
                    'fi': 'Tunti',
                    'sv': 'Timme',
                    'no': 'Time'
                },
                'Price': {
                    'fi': 'Hinta',
                    'sv': 'Pris',
                    'no': 'Pris'
                },
                'Electricity': {
                    'fi': 'Sähkö',
                    'sv': 'Elektricitet',
                    'no': 'Elektrisitet'
                },
                'ON': {
                    'fi': 'Päällä',
                    'sv': 'På',
                    'no': 'På'
                },
                'OFF': {
                    'fi': 'Pois',
                    'sv': 'Av',
                    'no': 'Av'
                },
                'offButton': {
                    'fi': 'Pois',
                    'sv': 'Av',
                    'no': 'Av'
                },
                'autoButton': {
                    'fi': 'Automaattinen',
                    'sv': '-',
                    'no': '-'
                },
                'onButton': {
                    'fi': 'Päällä',
                    'sv': 'På',
                    'no': 'På'
                },
            };

            // Function to preload translations and cache them
            function preloadTranslations() {
                Object.keys(translations).forEach(key => {
                    currentTranslations[key] = translations[key][userLang] || key;
                });
            }

            // Translate static text elements
            function translateStaticText() {
                document.getElementById('yesterday-menu').textContent = getTranslation('Yesterday');
                document.getElementById('today-menu').textContent = getTranslation('Today');
                document.getElementById('tomorrow-menu').textContent = getTranslation('Tomorrow');
                document.getElementById('offButton').textContent = getTranslation('offButton');
                document.getElementById('autoButton').textContent = getTranslation('autoButton');
                document.getElementById('onButton').textContent = getTranslation('onButton');
            }

            // Function to get translation from cached data
            function getTranslation(key) {
                return currentTranslations[key];
            }

            // Generate HTML for table with dynamic data
            function generateTableHTML(dateKeyPrefix) {
                const filteredData = Object.entries(priceData)
                    .filter(([key,]) => key.startsWith(dateKeyPrefix));

                const cheapestHoursKeys = calculateCheapestHours(Object.fromEntries(filteredData), cheapestHours);

                const tableRows = filteredData.map(([key, value]) => {
                    const hour = parseInt(key.slice(8, 10), 10);
                    const isCheapest = cheapestHoursKeys[key];
                    const isOn = value <= priceTrigger || isCheapest || currentStatus == 'ON';
                    const electricityStatus = isOn ? `<span class='power-on'>${getTranslation('ON')}</span>` : `<span class='power-off'>${getTranslation('OFF')}</span>`;
                    return `<tr><td>${hour}-${hour + 1}</td><td>${value.toFixed(2)}</td><td>${electricityStatus}</td></tr>`;
                });

                return `
            <table>
                <thead>
                    <tr>
                        <th data-translate="Hour">${getTranslation('Hour')}</th>
                        <th data-translate="Price">${getTranslation('Price')}</th>
                        <th data-translate="Electricity">${getTranslation('Electricity')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows.join('')}
                </tbody>
            </table>
        `;
            }

            // Update the active progress indicator
            function updateActiveProgress(activeMenuId) {
                document.querySelectorAll("#date li").forEach(menuItem => {
                    menuItem.classList.remove("active");
                });
                document.getElementById(activeMenuId).classList.add("active");
            }

            document.addEventListener("DOMContentLoaded", function () {
                preloadTranslations(); // Preload and cache translations
                translateStaticText();

                const selectMenu = document.getElementById('date-select');

                selectMenu.addEventListener("change", function () {
                    const selectedDate = selectMenu.value;
                    const dateOffset = {
                        'yesterday': -86400000,
                        'today': 0,
                        'tomorrow': 86400000
                    };

                    const targetDate = new Date(Date.now() + dateOffset[selectedDate]).toISOString().slice(0, 10).replace(/-/g, '');

                    document.getElementById('yesterday-data').innerHTML = '';
                    document.getElementById('today-data').innerHTML = '';
                    document.getElementById('tomorrow-data').innerHTML = '';
                    document.getElementById(`${selectedDate}-data`).innerHTML = generateTableHTML(targetDate);
                });

                // Initially load today's data
                document.getElementById('today-data').innerHTML = generateTableHTML(new Date().toISOString().slice(0, 10).replace(/-/g, ''));
            });
        </script>

    </footer>


</body>

</html>