<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="UTF-8">
        <title>Powerant</title>
        <link rel="stylesheet" href="Powerantuusi_tiedostot/styles.css">
       <script src="Powerantuusi_tiedostot/script.js"></script>
      </head>
      <body>
        
          
    <div style="display: flex; justify-content: space-between; align-items: center; background-color: #322f30; padding-left: 8vw; padding-right: 8vw; padding-right: 8vw; padding-top: 1vw; padding-bottom: 1vw; font-family: 'Arial', sans-serif;">
    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
            <div class="title"><span style="font-weight: bolder;">POWER</span><span style="font-weight: lighter;">ANT</span></div> 
    </div>
    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
        <div style="display: flex; align-items: center;">
            <div style="padding: 4px; position: relative; top: 12px; display: inline-block; border: 10px double transparent; border-top-color: #5db268; border-radius: 50%;">
                <div style="height: 0; width: 0; border: 10px double transparent; border-top-color: #5db268; border-radius: 50%;"> </div>
            </div>
            <span style="font-size: 24px; padding-right:10px; color: #ffffff;">Tylypahka</span>
        </div>
        <button id="disconnectButton" onclick="disconnectWifi()" style="background-color: #5db268; width: 100%; padding-right:10px; font-size: 24px; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, box-shadow 0.3s; position: relative; bottom: 10px;">Vaihda</button>
    </div>
</div>
          <div id="pricetable">
              <!-- Dropdown menu for date selection -->
                  <select id="date-select">
                      <option id="yesterday-menu" value="yesterday">Eilen</option>
                      <option id="today-menu" value="today" selected="selected">Tänään</option>
                      <option id="tomorrow-menu" value="tomorrow">Huomenna</option>
                  </select>
              <!-- tables -->
              <div id="price tables">
                  <div>
                      <div class="prices-container">
                          <div id="yesterday-data"></div>
                      </div>
                  </div>
                  <div class="current">
                      <div class="prices-container">
                          <div id="today-data">
                      <table>
                          <thead>
                              <tr>
                                  <th data-translate="Hour">Tunti</th>
                                  <th data-translate="Price">Hinta</th>
                                  <th data-translate="Electricity">Sähkö</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr><td>0-1</td><td>6.09</td><td><span class="power-on">Päällä</span></td></tr><tr><td>1-2</td><td>4.02</td><td><span class="power-on">Päällä</span></td></tr><tr><td>2-3</td><td>3.94</td><td><span class="power-on">Päällä</span></td></tr><tr><td>3-4</td><td>3.80</td><td><span class="power-on">Päällä</span></td></tr><tr><td>4-5</td><td>3.84</td><td><span class="power-on">Päällä</span></td></tr><tr><td>5-6</td><td>3.93</td><td><span class="power-on">Päällä</span></td></tr><tr><td>6-7</td><td>4.47</td><td><span class="power-on">Päällä</span></td></tr><tr><td>7-8</td><td>15.48</td><td><span class="power-off">Pois</span></td></tr><tr><td>8-9</td><td>17.98</td><td><span class="power-off">Pois</span></td></tr><tr><td>9-10</td><td>16.60</td><td><span class="power-off">Pois</span></td></tr><tr><td>10-11</td><td>13.14</td><td><span class="power-off">Pois</span></td></tr><tr><td>11-12</td><td>10.46</td><td><span class="power-off">Pois</span></td></tr><tr><td>12-13</td><td>7.70</td><td><span class="power-off">Pois</span></td></tr><tr><td>13-14</td><td>7.41</td><td><span class="power-on">Päällä</span></td></tr><tr><td>14-15</td><td>6.31</td><td><span class="power-on">Päällä</span></td></tr><tr><td>15-16</td><td>5.71</td><td><span class="power-on">Päällä</span></td></tr><tr><td>16-17</td><td>6.20</td><td><span class="power-on">Päällä</span></td></tr><tr><td>17-18</td><td>7.69</td><td><span class="power-on">Päällä</span></td></tr><tr><td>18-19</td><td>13.32</td><td><span class="power-off">Pois</span></td></tr><tr><td>19-20</td><td>15.50</td><td><span class="power-off">Pois</span></td></tr><tr><td>20-21</td><td>17.36</td><td><span class="power-off">Pois</span></td></tr><tr><td>21-22</td><td>19.19</td><td><span class="power-off">Pois</span></td></tr><tr><td>22-23</td><td>18.98</td><td><span class="power-off">Pois</span></td></tr><tr><td>23-24</td><td>16.74</td><td><span class="power-off">Pois</span></td></tr>
                          </tbody>
                      </table>
                  </div>
                      </div>
                  </div>
                  <div>
                      <div class="prices-container">
                          <div id="tomorrow-data"></div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="subtitle" id="subtitle">Määritä laitteesi:</div>
          <div class="button-container">
            <!-- Change type to 'button' to prevent form submission -->
            <button type="button" id="offButton" data-action="Off" class="off" onclick="updateStatus(event, 'Off')">Pois</button>
            <button type="button" id="autoButton" data-action="Automatic" class="auto active" onclick="updateStatus(event, 'Automatic')">Automaattinen</button>
            <button type="button" id="onButton" data-action="On" class="on" onclick="updateStatus(event, 'On')">Päällä</button>
          </div>
          <form class="form" action="/submit" method="POST">
           <div class="input-container ic5">
                <select id="hours" name="hours" class="input"><option value="0" selected="selected">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option></select>
                <div class="cut cut-short"></div>
                <label for="hours" class="placeholder hours" id="hoursLabel">Halvimmat tunnit</label>
              </div>
              <div class="input-container ic6">
                <input type="number" id="maxprice" name="maxprice" class="input" value="5" step="0.01">
                <div class="cut cut-short"></div>
                <label for="maxprice" class="placeholder maxprice" id="maxpriceLabel">Hintakatto</label>
              </div>
          <div class="input-container ic4">
          <select class="input" id="country" name="country"><option value="austria-at1">Austria</option><option value="belgium-be1">Belgium</option><option value="bulgaria-bg1">Bulgaria</option><option value="croatia-hr1">Croatia</option><option value="czech-republic-cz1">Czech Republic</option><option value="denmark-dk1">Denmark DK1</option><option value="denmark-dk2">Denmark DK2</option><option value="estonia-ee1">Estonia</option><option value="finland-fi1" selected="selected">Finland</option><option value="france-fr1">France</option><option value="germany-de1">Germany</option><option value="greece-gr1">Greece</option><option value="hungary-hu1">Hungary</option><option value="ireland-ie1">Ireland</option><option value="italy-calabria">Italy Calabria</option><option value="italy-centre-north">Italy Centre-North</option><option value="italy-centre-south">Italy Centre-South</option><option value="italy-north">Italy North</option><option value="italy-sacoac">Italy SACOAC</option><option value="italy-sacodc">Italy SACODC</option><option value="italy-sardinia">Italy Sardinia</option><option value="italy-sicily">Italy Sicily</option><option value="italy-south">Italy South</option><option value="latvia-lv1">Latvia</option><option value="lithuania-lt1">Lithuania</option><option value="netherlands-nl1">Netherlands</option><option value="norway-no1">Norway NO1</option><option value="norway-no2">Norway NO2</option><option value="norway-no3">Norway NO3</option><option value="norway-no4">Norway NO4</option><option value="norway-no5">Norway NO5</option><option value="poland-pl1">Poland</option><option value="portugal-pt1">Portugal</option><option value="romania-ro1">Romania</option><option value="serbia-rs1">Serbia</option><option value="spain-es1">Spain</option><option value="sweden-se1">Sweden SE1</option><option value="sweden-se2">Sweden SE2</option><option value="sweden-se3">Sweden SE3</option><option value="sweden-se4">Sweden SE4</option></select>
            <div class="cut cut-short"></div>
            
            <label for="country" class="placeholder country" id="countryLabel">Maa/Alue:</label>
            </div>
              <div class="checkbox-container">
                <input type="checkbox" id="show-settings" name="show-settings" onchange="toggleSettings()">
                <label for="show-settings" class="checkbox-label" id="settingsLabel">Näytä lisäasetukset:</label>
              </div>
              <div id="additional-settings" style="display: none;">
                <div class="input-container ic3">
                  <label class="checkbox-label" id="keyStatus">Tuoteavain: </label><span class="checkbox-label"></span> <br>
                  <label class="checkbox-label" id="ip-label">IP Address: </label><span class="checkbox-label">192.168.68.104</span>
                </div>
                <div class="input-container ic7" style="display:none;">
                  <input type="text" id="static-ip" name="static-ip" class="input">
                  <div class="cut"></div>
                  <label for="static-ip" class="placeholder staticip" id="ipLabel">Staattinen IP-osoite</label>
                </div>
                <div class="input-container ic8" style="display:none;">
                  <input type="text" id="server-address" name="server-address" class="input">
                  <div class="cut"></div>
                  <label for="server-address" class="placeholder server" id="serverLabel">Palvelimen osoite</label>
                </div>
                <div class="checkbox-container" style="display:none;">
                <input type="checkbox" id="configure-lan" name="configure-lan" value="on" onchange="toggleLANFields()">
                <label for="configure-lan" class="checkbox-label" id="lanConfigLabel">Määritä LAN:n kautta:</label>
                </div>
                <div id="lan-fields" style="display:none;">
                  <div class="input-container ic8">
                    <input type="text" id="lan-username" name="lan-username" class="input">
                    <div class="cut"></div>
                    <label for="lan-username" class="placeholder lanuser" id="lanUserLabel">LAN-käyttäjätunnus</label>
                  </div>
                  <div class="input-container ic10">
                    <input type="password" id="lan-password" name="lan-password" class="input" value="">
                    <div class="cut"></div>
                    <label for="lan-password" class="placeholder lanpassword" id="lanPasswordLabel">LAN-salasana</label>
                  </div>
                </div>
                <div class="checkbox-container" style="display:none;">
                <input type="checkbox" id="remote-control" name="remote-control" value="on" onchange="toggleAppFields()">
                <label for="remote-control" class="checkbox-label" id="remoteControlLabel">Etäohjaus Powerant-sovelluksella:</label>
                </div>
              </div>
              <input type="submit" class="submit" value="Tallenna" id="saveButton">
            </form>
            <button id="loginButton" onclick="logout()" style="background-color: #5db268; width: 100%; color: white; padding: 8vw; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, box-shadow 0.3s;">Kirjaudu sisään</button>
            <footer>
            <script>
              let currentStatus = 'Automatic'; 
              function setActiveButton(action) {
                  const buttons = document.querySelectorAll('button');
                  buttons.forEach(btn => {
                      if (btn.dataset.action === action) { // Use the passed action for comparison
                          btn.classList.add('active');
                      } else {
                          btn.classList.remove('active');
                      }
                  });
              }

              function updateStatus(event, action) {
                  event.preventDefault();  // Prevent form submission

                  // Update global currentStatus with the new action
                  currentStatus = action;
                  
                  // Call setActiveButton with the updated status
                  setActiveButton(currentStatus);
                  const selectMenu = document.getElementById('date-select');
                  updateTableData(selectMenu.value);

                  // Encode the currentStatus to ensure it's correctly formatted for a URL
                  const data = "deviceAction=" + encodeURIComponent(currentStatus);

                  const xhr = new XMLHttpRequest();
                  xhr.open("POST", "/submit", true);
                  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                  xhr.send(data); // Send the data including the currentStatus
              }

              window.onload = function() {
                  setActiveButton(currentStatus); // Set the correct active button when the page loads
              };
              const priceData = {"2024061001": 1.82, "2024061002": 1.59, "2024061003": 1.47, "2024061004": 1.36, "2024061005": 1.9, "2024061006": 3.43, "2024061007": 3.87, "2024061008": 9.97, "2024061009": 10.54, "2024061010": 8.68, "2024061011": 6.32, "2024061012": 7.89, "2024061013": 5.08, "2024061014": 3.97, "2024061015": 3.97, "2024061016": 3.95, "2024061017": 4.08, "2024061018": 4.07, "2024061019": 7.69, "2024061020": 7.32, "2024061021": 4.14, "2024061022": 4.02, "2024061023": 3.91, "2024061100": 3.4, "2024061101": 3.79, "2024061102": 3.72, "2024061103": 3.71, "2024061104": 3.71, "2024061105": 3.91, "2024061106": 4.65, "2024061107": 9.34, "2024061108": 12.71, "2024061109": 11.4, "2024061110": 8.47, "2024061111": 6.95, "2024061112": 5.95, "2024061113": 6.41, "2024061114": 6.39, "2024061115": 5.95, "2024061116": 5.21, "2024061117": 6.7, "2024061118": 4.71, "2024061119": 8.88, "2024061120": 14.15, "2024061121": 15.28, "2024061122": 14.81, "2024061123": 12.54, "2024061200": 6.09, "2024061201": 4.02, "2024061202": 3.94, "2024061203": 3.8, "2024061204": 3.84, "2024061205": 3.93, "2024061206": 4.47, "2024061207": 15.48, "2024061208": 17.98, "2024061209": 16.6, "2024061210": 13.14, "2024061211": 10.46, "2024061212": 7.7, "2024061213": 7.41, "2024061214": 6.31, "2024061215": 5.71, "2024061216": 6.2, "2024061217": 7.69, "2024061218": 13.32, "2024061219": 15.5, "2024061220": 17.36, "2024061221": 19.19, "2024061222": 18.98, "2024061223": 16.74, "2024061300": 5.11, "offset_hour": 3.0};
              const priceTrigger = 5; // Price below which the device is considered ON
              const cheapestHours = 12; // Number of hours when the device should be ON at the cheapest rates

              function calculateCheapestHours(data, count) {
                  return Object.entries(data)
                      .sort((a, b) => a[1] - b[1])
                      .slice(0, count)
                      .reduce((acc, [key,]) => ({ ...acc, [key]: true }), {});
              }

                // Default user language detection
                const userLang = (navigator.language || navigator.userLanguage).substring(0, 2); // Detect browser language once
              let currentTranslations = {}; // Cache for storing current translations

              // Translation dictionary
              const translations = {
                  'Yesterday': {
                      'fi': 'Eilen',
                      'sv': 'Igår',
                      'no': 'I går'
                  },
                  'Today': {
                      'fi': 'Tänään',
                      'sv': 'Idag',
                      'no': 'I dag'
                  },
                  'Tomorrow': {
                      'fi': 'Huomenna',
                      'sv': 'Imorgon',
                      'no': 'I morgen'
                  },
                  'Hour': {
                      'fi': 'Tunti',
                      'sv': 'Timme',
                      'no': 'Time'
                  },
                  'Price': {
                      'fi': 'Hinta',
                      'sv': 'Pris',
                      'no': 'Pris'
                  },
                  'Electricity': {
                      'fi': 'Sähkö',
                      'sv': 'Elektricitet',
                      'no': 'Elektrisitet'
                  },
                  'ON': {
                      'fi': 'Päällä',
                      'sv': 'På',
                      'no': 'På'
                  },
                  'OFF': {
                      'fi': 'Pois',
                      'sv': 'Av',
                      'no': 'Av'
                  },
                  'offButton': {
                      'fi': 'Pois',
                      'sv': 'Av',
                      'no': 'Av'
                  },
                  'autoButton': {
                      'fi': 'Automaattinen',
                      'sv': '-',
                      'no': '-'
                  },
                  'onButton': {
                      'fi': 'Päällä',
                      'sv': 'På',
                      'no': 'På'
                  },
              };

              // Function to preload translations and cache them
              function preloadTranslations() {
                  Object.keys(translations).forEach(key => {
                      currentTranslations[key] = translations[key][userLang] || key;
                  });
              }

              // Translate static text elements
              function translateStaticText() {
                  document.getElementById('yesterday-menu').textContent = getTranslation('Yesterday');
                  document.getElementById('today-menu').textContent = getTranslation('Today');
                  document.getElementById('tomorrow-menu').textContent = getTranslation('Tomorrow');
                  document.getElementById('offButton').textContent = getTranslation('offButton');
                  document.getElementById('autoButton').textContent = getTranslation('autoButton');
                  document.getElementById('onButton').textContent = getTranslation('onButton');
              }

              // Function to get translation from cached data
              function getTranslation(key) {
                  return currentTranslations[key];
              }

            // Generate HTML for table with dynamic data
              function generateTableHTML(dateKeyPrefix) {

                  const filteredData = Object.entries(priceData)
                      .filter(([key,]) => key.startsWith(dateKeyPrefix));

                  const cheapestHoursKeys = calculateCheapestHours(Object.fromEntries(filteredData), cheapestHours);

                  const tableRows = filteredData.map(([key, value]) => {
                      const hour = parseInt(key.slice(8, 10), 10);
                      const isCheapest = cheapestHoursKeys[key];
                      
                      let isOn = currentStatus == 'On' || value <= priceTrigger || isCheapest;
                      if (currentStatus == 'Off'){
                        isOn = false;
                      }
                      const electricityStatus = isOn ? `<span class='power-on'>${getTranslation('ON')}</span>` : `<span class='power-off'>${getTranslation('OFF')}</span>`;
                      return `<tr><td>${hour}-${hour + 1}</td><td>${value.toFixed(2)}</td><td>${electricityStatus}</td></tr>`;
                  });

                  return `
                      <table>
                          <thead>
                              <tr>
                                  <th data-translate="Hour">${getTranslation('Hour')}</th>
                                  <th data-translate="Price">${getTranslation('Price')}</th>
                                  <th data-translate="Electricity">${getTranslation('Electricity')}</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${tableRows.join('')}
                          </tbody>
                      </table>
                  `;
              }

              function updateTableData(selectedDate) {
                  const dateOffset = {
                      'yesterday': -86400000,
                      'today': 0,
                      'tomorrow': 86400000
                  };
                  
                  // Calculate the target date based on the selected date
                  const targetDate = new Date(Date.now() + dateOffset[selectedDate]).toISOString().slice(0, 10).replace(/-/g, '');

                  // Clear the existing data in table containers
                  document.getElementById('yesterday-data').innerHTML = '';
                  document.getElementById('today-data').innerHTML = '';
                  document.getElementById('tomorrow-data').innerHTML = '';

                  // Generate new table HTML for the selected date and set it
                  document.getElementById(`${selectedDate}-data`).innerHTML = generateTableHTML(targetDate);
              }



              // Update the active progress indicator
              function updateActiveProgress(activeMenuId) {
                  document.querySelectorAll("#date li").forEach(menuItem => {
                      menuItem.classList.remove("active");
                  });
                  document.getElementById(activeMenuId).classList.add("active");
              }

            document.addEventListener("DOMContentLoaded", function () {
                  preloadTranslations(); // Preload and cache translations
                  translateStaticText();

                  const selectMenu = document.getElementById('date-select');
                  
                  selectMenu.addEventListener("change", function () {
                      updateTableData(selectMenu.value);
                  });

                  // Initially load today's data
                  document.getElementById('today-data').innerHTML = generateTableHTML(new Date().toISOString().slice(0, 10).replace(/-/g, ''));
              });
          </script>

            </footer>
          
        
        </body></html>